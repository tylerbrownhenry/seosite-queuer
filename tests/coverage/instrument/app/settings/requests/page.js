
var __cov_Whmf5ZPFU_9OgBoqsW_Gmw = (Function('return this'))();
if (!__cov_Whmf5ZPFU_9OgBoqsW_Gmw.__coverage__) { __cov_Whmf5ZPFU_9OgBoqsW_Gmw.__coverage__ = {}; }
__cov_Whmf5ZPFU_9OgBoqsW_Gmw = __cov_Whmf5ZPFU_9OgBoqsW_Gmw.__coverage__;
if (!(__cov_Whmf5ZPFU_9OgBoqsW_Gmw['app/settings/requests/page.js'])) {
   __cov_Whmf5ZPFU_9OgBoqsW_Gmw['app/settings/requests/page.js'] = {"path":"app/settings/requests/page.js","s":{"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":1,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0,"44":0,"45":0,"46":0,"47":0,"48":0,"49":0,"50":0,"51":0,"52":0,"53":0,"54":0,"55":0,"56":0},"b":{"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0]},"f":{"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0},"fnMap":{"1":{"name":"pageRequest","line":19,"loc":{"start":{"line":19,"column":0},"end":{"line":19,"column":26}}},"2":{"name":"(anonymous_2)","line":35,"loc":{"start":{"line":35,"column":19},"end":{"line":35,"column":42}}},"3":{"name":"(anonymous_3)","line":50,"loc":{"start":{"line":50,"column":23},"end":{"line":50,"column":39}}},"4":{"name":"(anonymous_4)","line":64,"loc":{"start":{"line":64,"column":44},"end":{"line":64,"column":62}}},"5":{"name":"(anonymous_5)","line":90,"loc":{"start":{"line":90,"column":77},"end":{"line":90,"column":93}}},"6":{"name":"(anonymous_6)","line":92,"loc":{"start":{"line":92,"column":57},"end":{"line":92,"column":76}}},"7":{"name":"(anonymous_7)","line":105,"loc":{"start":{"line":105,"column":53},"end":{"line":105,"column":74}}},"8":{"name":"(anonymous_8)","line":111,"loc":{"start":{"line":111,"column":54},"end":{"line":111,"column":69}}},"9":{"name":"(anonymous_9)","line":123,"loc":{"start":{"line":123,"column":39},"end":{"line":123,"column":54}}}},"statementMap":{"1":{"start":{"line":1,"column":0},"end":{"line":1,"column":37}},"2":{"start":{"line":2,"column":0},"end":{"line":2,"column":46}},"3":{"start":{"line":3,"column":0},"end":{"line":3,"column":52}},"4":{"start":{"line":4,"column":0},"end":{"line":4,"column":58}},"5":{"start":{"line":5,"column":0},"end":{"line":5,"column":48}},"6":{"start":{"line":6,"column":0},"end":{"line":6,"column":61}},"7":{"start":{"line":7,"column":0},"end":{"line":7,"column":60}},"8":{"start":{"line":8,"column":0},"end":{"line":8,"column":47}},"9":{"start":{"line":9,"column":0},"end":{"line":9,"column":56}},"10":{"start":{"line":10,"column":0},"end":{"line":10,"column":21}},"11":{"start":{"line":11,"column":0},"end":{"line":11,"column":30}},"12":{"start":{"line":12,"column":0},"end":{"line":12,"column":30}},"13":{"start":{"line":19,"column":0},"end":{"line":134,"column":1}},"14":{"start":{"line":20,"column":5},"end":{"line":20,"column":29}},"15":{"start":{"line":21,"column":5},"end":{"line":21,"column":41}},"16":{"start":{"line":22,"column":5},"end":{"line":23,"column":38}},"17":{"start":{"line":25,"column":5},"end":{"line":33,"column":8}},"18":{"start":{"line":34,"column":5},"end":{"line":34,"column":46}},"19":{"start":{"line":35,"column":5},"end":{"line":132,"column":8}},"20":{"start":{"line":36,"column":10},"end":{"line":131,"column":11}},"21":{"start":{"line":37,"column":15},"end":{"line":37,"column":57}},"22":{"start":{"line":38,"column":15},"end":{"line":43,"column":18}},"23":{"start":{"line":45,"column":15},"end":{"line":45,"column":52}},"24":{"start":{"line":46,"column":15},"end":{"line":46,"column":54}},"25":{"start":{"line":47,"column":15},"end":{"line":130,"column":18}},"26":{"start":{"line":51,"column":20},"end":{"line":51,"column":63}},"27":{"start":{"line":52,"column":20},"end":{"line":52,"column":37}},"28":{"start":{"line":53,"column":20},"end":{"line":59,"column":21}},"29":{"start":{"line":54,"column":25},"end":{"line":54,"column":81}},"30":{"start":{"line":55,"column":25},"end":{"line":58,"column":28}},"31":{"start":{"line":61,"column":20},"end":{"line":61,"column":122}},"32":{"start":{"line":62,"column":20},"end":{"line":62,"column":41}},"33":{"start":{"line":64,"column":20},"end":{"line":129,"column":22}},"34":{"start":{"line":65,"column":25},"end":{"line":128,"column":26}},"35":{"start":{"line":66,"column":30},"end":{"line":66,"column":92}},"36":{"start":{"line":67,"column":30},"end":{"line":74,"column":33}},"37":{"start":{"line":75,"column":30},"end":{"line":75,"column":53}},"38":{"start":{"line":77,"column":30},"end":{"line":77,"column":61}},"39":{"start":{"line":78,"column":30},"end":{"line":78,"column":78}},"40":{"start":{"line":79,"column":30},"end":{"line":89,"column":32}},"41":{"start":{"line":90,"column":30},"end":{"line":127,"column":33}},"42":{"start":{"line":91,"column":35},"end":{"line":122,"column":36}},"43":{"start":{"line":92,"column":40},"end":{"line":115,"column":43}},"44":{"start":{"line":93,"column":45},"end":{"line":93,"column":66}},"45":{"start":{"line":94,"column":45},"end":{"line":101,"column":49}},"46":{"start":{"line":102,"column":45},"end":{"line":114,"column":47}},"47":{"start":{"line":106,"column":50},"end":{"line":106,"column":111}},"48":{"start":{"line":107,"column":50},"end":{"line":110,"column":53}},"49":{"start":{"line":112,"column":50},"end":{"line":112,"column":121}},"50":{"start":{"line":113,"column":50},"end":{"line":113,"column":70}},"51":{"start":{"line":117,"column":40},"end":{"line":117,"column":79}},"52":{"start":{"line":118,"column":40},"end":{"line":121,"column":43}},"53":{"start":{"line":124,"column":35},"end":{"line":124,"column":78}},"54":{"start":{"line":126,"column":35},"end":{"line":126,"column":55}},"55":{"start":{"line":133,"column":5},"end":{"line":133,"column":28}},"56":{"start":{"line":136,"column":0},"end":{"line":136,"column":29}}},"branchMap":{"1":{"line":36,"type":"if","locations":[{"start":{"line":36,"column":10},"end":{"line":36,"column":10}},{"start":{"line":36,"column":10},"end":{"line":36,"column":10}}]},"2":{"line":53,"type":"if","locations":[{"start":{"line":53,"column":20},"end":{"line":53,"column":20}},{"start":{"line":53,"column":20},"end":{"line":53,"column":20}}]},"3":{"line":65,"type":"if","locations":[{"start":{"line":65,"column":25},"end":{"line":65,"column":25}},{"start":{"line":65,"column":25},"end":{"line":65,"column":25}}]},"4":{"line":91,"type":"if","locations":[{"start":{"line":91,"column":35},"end":{"line":91,"column":35}},{"start":{"line":91,"column":35},"end":{"line":91,"column":35}}]}}};
}
__cov_Whmf5ZPFU_9OgBoqsW_Gmw = __cov_Whmf5ZPFU_9OgBoqsW_Gmw['app/settings/requests/page.js'];
__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['1']++;var dynamoose=require('dynamoose');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['2']++;var linkSchema=require('../../models/link');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['3']++;var requestSchema=require('../../models/request');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['4']++;var pageScanner=require('../../actions/scanPage/index');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['5']++;var updateCount=require('./page/updateCount');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['6']++;var createBulkUpdateCommands=require('./page/batchUpsert');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['7']++;var publisher=require('../../amqp-connections/publisher');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['8']++;var Link=dynamoose.model('Link',linkSchema);__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['9']++;var Request=dynamoose.model('Request',requestSchema);__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['10']++;var q=require('q');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['11']++;var _=require('underscore');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['12']++;var sh=require('shorthash');function pageRequest(msg){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['1']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['14']++;var promise=q.defer();__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['15']++;var input=JSON.parse(msg.content);__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['16']++;var parentLink=input.url,requestId=input.requestId;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['17']++;var _request=new Request({url:input.url,uid:input.user,options:input.options,id:input.requestId,requestDate:Date.now(),processes:0,status:'active'});__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['18']++;console.log('page.js saving request...');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['19']++;_request.save(function(err,result){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['2']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['20']++;if(err!==null){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['1'][0]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['21']++;console.log('page.js err saving request');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['22']++;promise.reject({requestId:requestId,status:'error',message:'Trouble saving request. Error: '+err,system:'mongo'});}else{__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['1'][1]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['23']++;console.log('page.js request saved');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['24']++;console.log('page.js begin page scan');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['25']++;pageScanner.init({url:parentLink,scanLinks:false}).then(function(data){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['3']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['26']++;console.log('page.js page scan responded');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['27']++;var linkObj={};__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['28']++;if(typeof data.foundLinks==='undefined'){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['2'][0]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['29']++;console.warn('page.js no links found during page scan');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['30']++;return promise.resolve({status:'success',data:'No links found to add to queue'});}else{__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['2'][1]++;}__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['31']++;var commands=createBulkUpdateCommands(linkObj,requestId,parentLink,data.foundLinks,data.baseUrl);__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['32']++;var updatedCount=0;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['33']++;Link.batchPut(commands,function(err,e){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['4']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['34']++;if(err!==null){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['3'][0]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['35']++;console.error('page.js error encourter while doing batchPut');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['36']++;promise.reject({system:'mongo',requestId:requestId,status:'error',message:'Trouble saving found links. Error: '+e.message,commands:commands,func:'Link.collection.bulkWrite'});__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['37']++;return promise.promise;}else{__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['3'][1]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['38']++;updatedCount=commands.length;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['39']++;console.error('page.js batchPut success',comm);__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['40']++;var put={processes:updatedCount-1,'dev_use_only_request':data.currentResponse,response:{resolvedUrl:data.baseUrl,statusMessage:data.currentResponse.statusMessage,'content-type':data.currentResponse.headers['content-type'],redirects:data.currentResponse.redirects.length,failedReason:data.currentResponse.failedReason}};__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['41']++;updateCount(requestId,updatedCount,put).then(function(resp){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['5']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['42']++;if(commands.length!==0){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['4'][0]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['43']++;_.each(commands,function(command){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['6']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['44']++;var id=command._id;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['45']++;var buffer=new Buffer(JSON.stringify({url:linkObj[id].resolvedUrl,requestId:requestId,linkId:linkObj[id]._id,uid:input.user,baseUrl:parentLink,_link:linkObj[id]}));__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['46']++;publisher.publish('','links',buffer,{type:parentLink,messageId:linkObj[id]._id}).then(function(err,data){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['7']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['47']++;console.log('page.js links successfully published to queue');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['48']++;promise.resolve({status:'success',data:'New links added to queue'});}).catch(function(err){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['8']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['49']++;console.error('page.js trouble publishing links to queue pageScanner');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['50']++;promise.reject(err);});});}else{__cov_Whmf5ZPFU_9OgBoqsW_Gmw.b['4'][1]++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['51']++;console.warn('page.js no links found');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['52']++;promise.resolve({status:'success',data:'No new links found to add to queue'});}}).catch(function(err){__cov_Whmf5ZPFU_9OgBoqsW_Gmw.f['9']++;__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['53']++;console.error('page.js updateCount error');__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['54']++;promise.reject(err);});}});});}});__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['55']++;return promise.promise;}__cov_Whmf5ZPFU_9OgBoqsW_Gmw.s['56']++;module.exports=pageRequest;
