
var __cov_z9iXkTPBPYO1dz_pKGe9mg = (Function('return this'))();
if (!__cov_z9iXkTPBPYO1dz_pKGe9mg.__coverage__) { __cov_z9iXkTPBPYO1dz_pKGe9mg.__coverage__ = {}; }
__cov_z9iXkTPBPYO1dz_pKGe9mg = __cov_z9iXkTPBPYO1dz_pKGe9mg.__coverage__;
if (!(__cov_z9iXkTPBPYO1dz_pKGe9mg['app/settings/requests/links/process.js'])) {
   __cov_z9iXkTPBPYO1dz_pKGe9mg['app/settings/requests/links/process.js'] = {"path":"app/settings/requests/links/process.js","s":{"1":0,"2":1,"3":0,"4":0,"5":1,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0,"42":0,"43":0},"b":{"1":[0,0],"2":[0,0],"3":[0,0]},"f":{"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0},"fnMap":{"1":{"name":"updateCount","line":18,"loc":{"start":{"line":18,"column":0},"end":{"line":18,"column":56}}},"2":{"name":"processLinks","line":38,"loc":{"start":{"line":38,"column":0},"end":{"line":38,"column":54}}},"3":{"name":"(anonymous_3)","line":48,"loc":{"start":{"line":48,"column":19},"end":{"line":48,"column":35}}},"4":{"name":"(anonymous_4)","line":72,"loc":{"start":{"line":72,"column":29},"end":{"line":72,"column":47}}},"5":{"name":"(anonymous_5)","line":83,"loc":{"start":{"line":83,"column":61},"end":{"line":83,"column":77}}},"6":{"name":"(anonymous_6)","line":85,"loc":{"start":{"line":85,"column":32},"end":{"line":85,"column":51}}},"7":{"name":"(anonymous_7)","line":99,"loc":{"start":{"line":99,"column":28},"end":{"line":99,"column":49}}},"8":{"name":"(anonymous_8)","line":109,"loc":{"start":{"line":109,"column":29},"end":{"line":109,"column":44}}},"9":{"name":"(anonymous_9)","line":114,"loc":{"start":{"line":114,"column":19},"end":{"line":114,"column":34}}}},"statementMap":{"1":{"start":{"line":1,"column":0},"end":{"line":9,"column":22}},"2":{"start":{"line":18,"column":0},"end":{"line":30,"column":2}},"3":{"start":{"line":19,"column":6},"end":{"line":28,"column":7}},"4":{"start":{"line":29,"column":6},"end":{"line":29,"column":62}},"5":{"start":{"line":38,"column":0},"end":{"line":125,"column":1}},"6":{"start":{"line":39,"column":5},"end":{"line":39,"column":29}},"7":{"start":{"line":40,"column":5},"end":{"line":40,"column":27}},"8":{"start":{"line":41,"column":5},"end":{"line":41,"column":27}},"9":{"start":{"line":42,"column":5},"end":{"line":42,"column":34}},"10":{"start":{"line":44,"column":5},"end":{"line":44,"column":46}},"11":{"start":{"line":45,"column":5},"end":{"line":45,"column":23}},"12":{"start":{"line":46,"column":5},"end":{"line":46,"column":22}},"13":{"start":{"line":48,"column":5},"end":{"line":68,"column":8}},"14":{"start":{"line":49,"column":10},"end":{"line":49,"column":64}},"15":{"start":{"line":50,"column":10},"end":{"line":67,"column":11}},"16":{"start":{"line":51,"column":15},"end":{"line":64,"column":18}},"17":{"start":{"line":65,"column":15},"end":{"line":65,"column":33}},"18":{"start":{"line":66,"column":15},"end":{"line":66,"column":38}},"19":{"start":{"line":70,"column":5},"end":{"line":70,"column":26}},"20":{"start":{"line":72,"column":5},"end":{"line":123,"column":8}},"21":{"start":{"line":73,"column":10},"end":{"line":73,"column":46}},"22":{"start":{"line":74,"column":10},"end":{"line":76,"column":11}},"23":{"start":{"line":75,"column":12},"end":{"line":75,"column":263}},"24":{"start":{"line":80,"column":10},"end":{"line":80,"column":41}},"25":{"start":{"line":81,"column":10},"end":{"line":81,"column":49}},"26":{"start":{"line":83,"column":10},"end":{"line":122,"column":13}},"27":{"start":{"line":84,"column":15},"end":{"line":84,"column":72}},"28":{"start":{"line":85,"column":15},"end":{"line":113,"column":18}},"29":{"start":{"line":86,"column":20},"end":{"line":86,"column":41}},"30":{"start":{"line":87,"column":20},"end":{"line":94,"column":24}},"31":{"start":{"line":95,"column":20},"end":{"line":112,"column":22}},"32":{"start":{"line":100,"column":25},"end":{"line":100,"column":83}},"33":{"start":{"line":101,"column":25},"end":{"line":101,"column":38}},"34":{"start":{"line":102,"column":25},"end":{"line":104,"column":26}},"35":{"start":{"line":103,"column":27},"end":{"line":103,"column":37}},"36":{"start":{"line":105,"column":25},"end":{"line":108,"column":28}},"37":{"start":{"line":110,"column":25},"end":{"line":110,"column":79}},"38":{"start":{"line":111,"column":25},"end":{"line":111,"column":45}},"39":{"start":{"line":115,"column":15},"end":{"line":115,"column":72}},"40":{"start":{"line":116,"column":15},"end":{"line":116,"column":65}},"41":{"start":{"line":120,"column":15},"end":{"line":120,"column":285}},"42":{"start":{"line":124,"column":5},"end":{"line":124,"column":28}},"43":{"start":{"line":126,"column":0},"end":{"line":126,"column":30}}},"branchMap":{"1":{"line":50,"type":"if","locations":[{"start":{"line":50,"column":10},"end":{"line":50,"column":10}},{"start":{"line":50,"column":10},"end":{"line":50,"column":10}}]},"2":{"line":74,"type":"if","locations":[{"start":{"line":74,"column":10},"end":{"line":74,"column":10}},{"start":{"line":74,"column":10},"end":{"line":74,"column":10}}]},"3":{"line":102,"type":"if","locations":[{"start":{"line":102,"column":25},"end":{"line":102,"column":25}},{"start":{"line":102,"column":25},"end":{"line":102,"column":25}}]}}};
}
__cov_z9iXkTPBPYO1dz_pKGe9mg = __cov_z9iXkTPBPYO1dz_pKGe9mg['app/settings/requests/links/process.js'];
__cov_z9iXkTPBPYO1dz_pKGe9mg.s['1']++;var notify=require('../../../actions/callback'),dynamoose=require('dynamoose'),linkSchema=require('../../../models/link'),Link=dynamoose.model('Link',linkSchema),_updateCount=require('../page/updateCount'),_=require('underscore'),sh=require('shorthash'),utils=require('../../../utils'),q=require('q');function updateCount(requestId,updatedCount,response){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['1']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['3']++;var putObject={processes:updatedCount-1,dev_use_only_request:response.currentResponse,response:{resolvedUrl:response.url.resolvedUrl,statusMessage:'Success',redirects:response.redirects,failedReason:null}};__cov_z9iXkTPBPYO1dz_pKGe9mg.s['4']++;return _updateCount(requestId,updatedCount,putObject);}function processLinks(input,res,requestId,newScan){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['2']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['6']++;var promise=q.defer();__cov_z9iXkTPBPYO1dz_pKGe9mg.s['7']++;var links=res.links;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['8']++;res.links=undefined;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['9']++;res.linkCount=links.length;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['10']++;var parentLink=newScan.url.resolvedUrl;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['11']++;var commands=[];__cov_z9iXkTPBPYO1dz_pKGe9mg.s['12']++;var linkObj={};__cov_z9iXkTPBPYO1dz_pKGe9mg.s['13']++;_.each(links,function(link){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['3']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['14']++;var linkId=sh.unique(link.url.original+requestId);__cov_z9iXkTPBPYO1dz_pKGe9mg.s['15']++;if(typeof linkObj[linkId]==='undefined'){__cov_z9iXkTPBPYO1dz_pKGe9mg.b['1'][0]++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['16']++;commands.push({'_id':linkId,'__scan':{},'__link':link,'found':Date(),'linkId':linkId,'resolvedUrl':parentLink,'requestId':requestId,'scanned':null,'status':'pending','site':parentLink,'uid':input.uid,'url':link.url.original});__cov_z9iXkTPBPYO1dz_pKGe9mg.s['17']++;link._id=linkId;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['18']++;linkObj[linkId]=link;}else{__cov_z9iXkTPBPYO1dz_pKGe9mg.b['1'][1]++;}});__cov_z9iXkTPBPYO1dz_pKGe9mg.s['19']++;var updatedCount=0;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['20']++;Link.batchPut(commands,function(err,e){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['4']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['21']++;console.log('summary.js line ~350');__cov_z9iXkTPBPYO1dz_pKGe9mg.s['22']++;if(err!==null){__cov_z9iXkTPBPYO1dz_pKGe9mg.b['2'][0]++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['23']++;return promise.reject(promise,'database','Trouble saving request links.',true,input,page,true,'links.process.batchPut',{requestId:requestId,updatedCount:updatedCount,newScan:newScan,commands:commands,parentLink:parentLink,requestId:requestId});}else{__cov_z9iXkTPBPYO1dz_pKGe9mg.b['2'][1]++;}__cov_z9iXkTPBPYO1dz_pKGe9mg.s['24']++;updatedCount=commands.length;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['25']++;console.log('summary.js updatedCount');__cov_z9iXkTPBPYO1dz_pKGe9mg.s['26']++;updateCount(requestId,updatedCount,newScan).then(function(resp){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['5']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['27']++;console.log('summary.js updatedCount response',commands);__cov_z9iXkTPBPYO1dz_pKGe9mg.s['28']++;_.each(commands,function(command){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['6']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['29']++;var id=command._id;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['30']++;var buffer=new Buffer(JSON.stringify({url:linkObj[id].resolvedUrl,requestId:requestId,linkId:linkObj[id]._id,uid:input.uid,baseUrl:parentLink,_link:linkObj[id]}));__cov_z9iXkTPBPYO1dz_pKGe9mg.s['31']++;publisher.publish('','links',buffer,{type:parentLink,messageId:linkObj[id]._id,uid:input.uid}).then(function(err,data){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['7']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['32']++;console.log('summary.js successfully published to queue');__cov_z9iXkTPBPYO1dz_pKGe9mg.s['33']++;var add='';__cov_z9iXkTPBPYO1dz_pKGe9mg.s['34']++;if(commands.length>1){__cov_z9iXkTPBPYO1dz_pKGe9mg.b['3'][0]++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['35']++;add='s';}else{__cov_z9iXkTPBPYO1dz_pKGe9mg.b['3'][1]++;}__cov_z9iXkTPBPYO1dz_pKGe9mg.s['36']++;promise.resolve({status:'working',message:'Found '+commands.length+' link'+add});}).catch(function(err){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['8']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['37']++;console.error('summary.js error publishing to queue');__cov_z9iXkTPBPYO1dz_pKGe9mg.s['38']++;promise.reject(err);});});}).catch(function(err){__cov_z9iXkTPBPYO1dz_pKGe9mg.f['9']++;__cov_z9iXkTPBPYO1dz_pKGe9mg.s['39']++;console.warn('summary.js error updating count for scan');__cov_z9iXkTPBPYO1dz_pKGe9mg.s['40']++;console.log('Error/Success pageScanner...8',err);__cov_z9iXkTPBPYO1dz_pKGe9mg.s['41']++;promise.reject(promise,'database','Trouble updating link count for request.',true,input,page,true,'settings.request.summary.newScan.save',{requestId:requestId,updatedCount:updatedCount,newScan:newScan,commands:commands,parentLink:parentLink,requestId:requestId});});});__cov_z9iXkTPBPYO1dz_pKGe9mg.s['42']++;return promise.promise;}__cov_z9iXkTPBPYO1dz_pKGe9mg.s['43']++;module.exports=processLinks;
